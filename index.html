<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Montador 3D – Mobile</title>
  <style>
    :root { --bg:#0b1020; --panel:#0d172f; --line:#1e2a4a; --text:#e9f1ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding:10px 14px; display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,16,32,.9); backdrop-filter: blur(6px); z-index:10 }
    h1 { font-size:16px; margin:0; font-weight:600 }
    #wrap { display:grid; grid-template-columns: 260px 1fr; height: calc(100vh - 52px); }
    #left { border-right:1px solid var(--line); padding:10px; overflow:auto }
    #right { position:relative; }
    #three { width:100%; height:100%; display:block }
    .group { margin-bottom:10px; }
    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
    button, select { background:#101a38; color:var(--text); border:1px solid #2a3b6a; border-radius:12px; padding:10px; font-size:14px; }
    button:active { transform: scale(0.98); }
    .pill { padding:6px 10px; border-radius:999px; background:#0d172f; border:1px solid #263a6a; font-size:12px; }
    #hud { position:absolute; right:10px; bottom:10px; display:flex; flex-direction:column; gap:8px; }
    .fab { background:#15244a; border:1px solid #2a3b6a; border-radius:14px; padding:8px 10px; display:flex; gap:8px; align-items:center; }
    .fab button { padding:8px 10px; border-radius:10px; }
    #snack { position:fixed; left:50%; transform:translateX(-50%); bottom:14px; background:#0d172f; border:1px solid #263a6a; padding:8px 12px; border-radius:10px; font-size:12px; display:none; }
    @media (max-width: 950px) { #wrap { grid-template-columns: 1fr; } #left { border-right:none; border-top:1px solid var(--line); order:2; } #right { order:1; height: 55vh; } }
  </style>
</head>
<body>
  <header>
    <h1>Montador 3D – Mobile</h1>
    <button id="btnFinalize">Finalizar</button>
    <button id="btnExport">Exportar (JSON)</button>
  </header>
  <div id="wrap">
    <aside id="left">
      <div class="group">
        <p><strong>Chassi</strong></p>
        <div class="grid">
          <button data-add="chassi:ret">Retangular</button>
          <button data-add="chassi:trap">Trapézio</button>
        </div>
      </div>
      <div class="group">
        <p><strong>Locomoção</strong></p>
        <div class="grid">
          <button data-add="roda">Roda</button>
          <button data-add="roda_castor">Roda castor</button>
          <button data-add="servo">Servo</button>
          <button data-add="ponte_h">Ponte H</button>
        </div>
      </div>
      <div class="group">
        <p><strong>Computação</strong></p>
        <div class="grid">
          <button data-add="jetson">Jetson Nano</button>
          <button data-add="raspi">Raspberry Pi</button>
          <button data-add="bateria">Bateria</button>
        </div>
      </div>
      <div class="group">
        <p><strong>Sensores</strong></p>
        <div class="grid">
          <button data-add="lidar2d">LiDAR 2D</button>
          <button data-add="lidar3d">LiDAR 3D</button>
          <button data-add="cam_rgb">Câmera RGB</button>
          <button data-add="cam_depth">Câmera de profundidade</button>
          <button data-add="radar">Radar</button>
        </div>
      </div>
      <div class="group">
        <p><strong>Posicionamento rápido</strong></p>
        <div class="grid">
          <button data-slot="wheelFL">Roda FL</button>
          <button data-slot="wheelFR">Roda FR</button>
          <button data-slot="wheelRL">Roda RL</button>
          <button data-slot="wheelRR">Roda RR</button>
          <button data-slot="top">Topo</button>
          <button data-slot="front">Frente</button>
        </div>
      </div>
    </aside>
    <main id="right">
      <canvas id="three"></canvas>
      <div id="hud">
        <div class="fab"><span class="pill" id="selLabel">Nenhuma peça</span></div>
        <div class="fab">
          <button id="mvUp">▲</button><button id="mvDown">▼</button><button id="mvLeft">◀</button><button id="mvRight">▶</button>
          <button id="rotL">↩️</button><button id="rotR">↪️</button>
        </div>
        <div class="fab"><button id="btnSnap">Snap ao slot</button><button id="btnRemove">Remover</button></div>
      </div>
    </main>
  </div>
  <div id="snack"></div>

  <script>
    // Loader com fallbacks de CDN p/ Three.js + OrbitControls
    function addScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(new Error('fail '+src));document.head.appendChild(s);});}
    async function loadThree(){
      const libs=[
        'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js',
        'https://unpkg.com/three@0.160.0/build/three.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js'
      ];
      let ok=false; for(const u of libs){try{await addScript(u); if(window.THREE){ok=true; break;}}catch(e){}}
      if(!ok) throw new Error('Three.js não carregou (CDN bloqueada)');
      const ctrls=[
        'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js',
        'https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js'
      ];
      for(const u of ctrls){try{await addScript(u); if(THREE.OrbitControls) break;}catch(e){}}
    }

    (async()=>{
      try{ await loadThree(); }catch(e){ alert(e.message); return; }

      const canvas = document.getElementById('three');
      const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
      const scene = new THREE.Scene(); scene.background = new THREE.Color(0x0b1020);
      const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 200); camera.position.set(8,8,12);
      const orbit = new THREE.OrbitControls(camera, renderer.domElement); orbit.target.set(0,0,0);

      scene.add(new THREE.AmbientLight(0xffffff, 0.35));
      const dir = new THREE.DirectionalLight(0xffffff, 1); dir.position.set(10,20,10); scene.add(dir);

      const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshPhongMaterial({color:0x0d1728, side:THREE.DoubleSide}));
      ground.rotation.x = -Math.PI/2; ground.position.y = -0.01; scene.add(ground);

      const parts = []; let chassis = null; let selected = null; let lastSlot = 'top';
      function toast(msg){ const s=document.getElementById('snack'); s.textContent = msg; s.style.display='block'; clearTimeout(s._t); s._t=setTimeout(()=>s.style.display='none', 1400); }
      function setSelected(m){ selected = m; document.getElementById('selLabel').textContent = selected? (selected.userData.label||'Peça'): 'Nenhuma peça'; }
      function ensureChassis(){ if(chassis) return; const matGray = new THREE.MeshPhongMaterial({color:0x888888}); chassis = new THREE.Mesh(new THREE.BoxGeometry(6,0.4,8), matGray); chassis.position.set(0,0.2,0); chassis.userData={type:'chassi',label:'Chassi'}; scene.add(chassis); }

      function addPart(key){
        ensureChassis();
        let mesh; const matGray = new THREE.MeshPhongMaterial({color:0x888888});
        const matBlack= new THREE.MeshPhongMaterial({color:0x111111});
        const matBlue = new THREE.MeshPhongMaterial({color:0x59b4ff});
        const matGreen= new THREE.MeshPhongMaterial({color:0x2ecc71});
        const matRed  = new THREE.MeshPhongMaterial({color:0xff5a5a});
        const matYellow=new THREE.MeshPhongMaterial({color:0xf0d24d});
        if(key==='chassi:ret'){ if(chassis) scene.remove(chassis); chassis = new THREE.Mesh(new THREE.BoxGeometry(6,0.4,8), matGray); chassis.position.set(0,0.2,0); chassis.userData={type:'chassi',label:'Chassi'}; scene.add(chassis); setSelected(chassis); return; }
        if(key==='chassi:trap'){ if(chassis) scene.remove(chassis); const g = new THREE.CylinderGeometry(3.2, 2.2, 0.4, 4); g.rotateY(Math.PI/4); chassis = new THREE.Mesh(g, matGray); chassis.position.set(0,0.2,0); chassis.userData={type:'chassi',label:'Chassi'}; scene.add(chassis); setSelected(chassis); return; }
        switch(key){
          case 'roda': mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.8,0.8,0.4, 24), matBlack); mesh.rotation.z=Math.PI/2; mesh.userData.label='Roda'; lastSlot='wheelFL'; break;
          case 'roda_castor': mesh = new THREE.Mesh(new THREE.SphereGeometry(0.4, 18, 18), matBlack); mesh.userData.label='Roda castor'; lastSlot='front'; break;
          case 'servo': mesh = new THREE.Mesh(new THREE.BoxGeometry(1,0.8,1.6), matBlue); mesh.userData.label='Servo'; lastSlot='top'; break;
          case 'ponte_h': mesh = new THREE.Mesh(new THREE.BoxGeometry(1.2,0.5,1.2), matRed); mesh.userData.label='Ponte H'; lastSlot='top'; break;
          case 'jetson': mesh = new THREE.Mesh(new THREE.BoxGeometry(1.6,0.4,1.2), matGreen); mesh.userData.label='Jetson Nano'; lastSlot='top'; break;
          case 'raspi': mesh = new THREE.Mesh(new THREE.BoxGeometry(1.4,0.35,0.9), matGreen); mesh.userData.label='Raspberry Pi'; lastSlot='top'; break;
          case 'bateria': mesh = new THREE.Mesh(new THREE.BoxGeometry(1.8,0.7,1), matYellow); mesh.userData.label='Bateria'; lastSlot='top'; break;
          case 'lidar2d': mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.3, 24), new THREE.MeshPhongMaterial({color:0x69a5ff})); mesh.userData.label='LiDAR 2D'; lastSlot='front'; break;
          case 'lidar3d': mesh = new THREE.Mesh(new THREE.SphereGeometry(0.5, 18, 18), new THREE.MeshPhongMaterial({color:0xffffff})); mesh.userData.label='LiDAR 3D'; lastSlot='top'; break;
          case 'cam_rgb': mesh = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.6,0.6), new THREE.MeshPhongMaterial({color:0x3333ff})); mesh.userData.label='Câmera RGB'; lastSlot='front'; break;
          case 'cam_depth': mesh = new THREE.Mesh(new THREE.BoxGeometry(1.2,0.5,0.5), new THREE.MeshPhongMaterial({color:0x55ffcc})); mesh.userData.label='Câmera de profundidade'; lastSlot='front'; break;
          case 'radar': mesh = new THREE.Mesh(new THREE.ConeGeometry(0.6, 1, 18), new THREE.MeshPhongMaterial({color:0xffaa00})); mesh.rotation.x=-Math.PI/2; mesh.userData.label='Radar'; lastSlot='front'; break;
          default: return;
        }
        scene.add(mesh); parts.push(mesh); setSelected(mesh); snapTo(lastSlot); toast(selected.userData.label+ ' adicionada');
      }

      function snapTo(key){
        if(!chassis || !selected) return;
        const b=new THREE.Box3().setFromObject(chassis); const c=b.getCenter(new THREE.Vector3());
        const y=b.max.y + 0.02; const dx=(b.max.x-b.min.x)/2 - 0.6; const dz=(b.max.z-b.min.z)/2 - 0.6; const t=selected;
        if(key==='wheelFL') t.position.set(c.x - dx, b.min.y + 0.4, c.z + dz);
        if(key==='wheelFR') t.position.set(c.x + dx, b.min.y + 0.4, c.z + dz);
        if(key==='wheelRL') t.position.set(c.x - dx, b.min.y + 0.4, c.z - dz);
        if(key==='wheelRR') t.position.set(c.x + dx, b.min.y + 0.4, c.z - dz);
        if(key==='top')      t.position.set(c.x, y + 0.6, c.z);
        if(key==='front')    t.position.set(c.x, y + 0.4, b.max.z + 0.5);
      }

      document.querySelectorAll('[data-add]').forEach(b=> b.onclick = ()=> addPart(b.getAttribute('data-add')));
      document.querySelectorAll('[data-slot]').forEach(b=> b.onclick = ()=> { lastSlot = b.getAttribute('data-slot'); snapTo(lastSlot); });

      const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
      renderer.domElement.addEventListener('pointerdown', (e)=>{
        const r = renderer.domElement.getBoundingClientRect(); mouse.x = ((e.clientX - r.left)/r.width)*2 - 1; mouse.y = -((e.clientY - r.top)/r.height)*2 + 1; ray.setFromCamera(mouse, camera);
        const hits = ray.intersectObjects(parts.concat(chassis? [chassis]: [])); if(hits[0]) setSelected(hits[0].object);
      });

      const step=0.2, rot=0.15;
      mvUp.onclick   = ()=>{ if(selected) selected.position.z -= step; };
      mvDown.onclick = ()=>{ if(selected) selected.position.z += step; };
      mvLeft.onclick = ()=>{ if(selected) selected.position.x -= step; };
      mvRight.onclick= ()=>{ if(selected) selected.position.x += step; };
      rotL.onclick   = ()=>{ if(selected) selected.rotation.y += rot; };
      rotR.onclick   = ()=>{ if(selected) selected.rotation.y -= rot; };
      btnSnap.onclick= ()=> snapTo(lastSlot);
      btnRemove.onclick= ()=>{ if(selected && selected!==chassis){ scene.remove(selected); const i=parts.indexOf(selected); if(i>=0) parts.splice(i,1); setSelected(null); } };

      btnFinalize.onclick = ()=>{ orbit.target.set(0,0,0); camera.position.set(10,10,12); };
      btnExport.onclick = ()=>{
        const data = parts.map(m=>({label:m.userData.label, pos:{x:m.position.x,y:m.position.y,z:m.position.z}, rot:{x:m.rotation.x,y:m.rotation.y,z:m.rotation.z}}));
        const json = JSON.stringify(data, null, 2); const blob = new Blob([json], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='montagem.json'; a.click(); URL.revokeObjectURL(url);
      };

      function resize(){ const el = canvas.parentElement; const w = el.clientWidth; const h = el.clientHeight || Math.round(window.innerHeight*0.6); renderer.setSize(w,h,false); camera.aspect = w/h; camera.updateProjectionMatrix(); }
      window.addEventListener('resize', resize); resize();

      function loop(){ renderer.render(scene, camera); requestAnimationFrame(loop); } loop();
    })();
  </script>
</body>
</html>
